{"version":3,"file":"middletier.js","mappings":"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","sources":["webpack://office-addin-taskpane-sso/./src/middle-tier/msgraph-helper.ts","webpack://office-addin-taskpane-sso/./src/middle-tier/ssoauth-helper.ts","webpack://office-addin-taskpane-sso/external commonjs \"cookie-parser\"","webpack://office-addin-taskpane-sso/external commonjs \"dotenv\"","webpack://office-addin-taskpane-sso/external commonjs \"express\"","webpack://office-addin-taskpane-sso/external commonjs \"form-urlencoded\"","webpack://office-addin-taskpane-sso/external commonjs \"http-errors\"","webpack://office-addin-taskpane-sso/external commonjs \"jsonwebtoken\"","webpack://office-addin-taskpane-sso/external commonjs \"jwks-rsa\"","webpack://office-addin-taskpane-sso/external commonjs \"morgan\"","webpack://office-addin-taskpane-sso/external commonjs \"node-fetch\"","webpack://office-addin-taskpane-sso/external commonjs \"office-addin-dev-certs\"","webpack://office-addin-taskpane-sso/external commonjs \"path\"","webpack://office-addin-taskpane-sso/external node-commonjs \"https\"","webpack://office-addin-taskpane-sso/webpack/bootstrap","webpack://office-addin-taskpane-sso/webpack/runtime/compat get default export","webpack://office-addin-taskpane-sso/webpack/runtime/define property getters","webpack://office-addin-taskpane-sso/webpack/runtime/hasOwnProperty shorthand","webpack://office-addin-taskpane-sso/webpack/runtime/make namespace object","webpack://office-addin-taskpane-sso/./src/middle-tier/app.ts"],"sourcesContent":["// Copyright (c) Microsoft. All rights reserved. Licensed under the MIT license. See full license in the root of the repo.\n/*\n    This file provides the provides functionality to get Microsoft Graph data.\n*/\nimport * as https from \"https\";\nimport { getAccessToken } from \"./ssoauth-helper\";\nimport * as createError from \"http-errors\";\n\n/* global process */\n\nconst domain: string = \"graph.microsoft.com\";\nconst version: string = \"v1.0\";\n\nexport async function getUserData(req: any, res: any, next: any) {\n  const authorization: string = req.get(\"Authorization\");\n\n  await getAccessToken(authorization)\n    .then(async (graphTokenResponse) => {\n      if (graphTokenResponse && (graphTokenResponse.claims || graphTokenResponse.error)) {\n        res.send(graphTokenResponse);\n      } else {\n        const graphToken: string = graphTokenResponse.access_token;\n        const graphUrlSegment: string = process.env.GRAPH_URL_SEGMENT || \"/me\";\n        const graphQueryParamSegment: string = process.env.QUERY_PARAM_SEGMENT || \"\";\n\n        const graphData = await getGraphData(graphToken, graphUrlSegment, graphQueryParamSegment);\n\n        // If Microsoft Graph returns an error, such as invalid or expired token,\n        // there will be a code property in the returned object set to a HTTP status (e.g. 401).\n        // Relay it to the client. It will caught in the fail callback of `makeGraphApiCall`.\n        if (graphData.code) {\n          next(createError(graphData.code, \"Microsoft Graph error \" + JSON.stringify(graphData)));\n        } else {\n          res.send(graphData);\n        }\n      }\n    })\n    .catch((err) => {\n      res.status(401).send(err.message);\n      return;\n    });\n}\n\nexport async function getGraphData(accessToken: string, apiUrl: string, queryParams?: string): Promise<any> {\n  return new Promise<any>((resolve, reject) => {\n    const options: https.RequestOptions = {\n      host: domain,\n      path: \"/\" + version + apiUrl + queryParams,\n      method: \"GET\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        Accept: \"application/json\",\n        Authorization: \"Bearer \" + accessToken,\n        \"Cache-Control\": \"private, no-cache, no-store, must-revalidate\",\n        Expires: \"-1\",\n        Pragma: \"no-cache\",\n      },\n    };\n\n    https\n      .get(options, (response) => {\n        let body = \"\";\n        response.on(\"data\", (d) => {\n          body += d;\n        });\n        response.on(\"end\", () => {\n          // The response from the OData endpoint might be an error, say a\n          // 401 if the endpoint requires an access token and it was invalid\n          // or expired. But a message is not an error in the call of https.get,\n          // so the \"on('error', reject)\" line below isn't triggered.\n          // So, the code distinguishes success (200) messages from error\n          // messages and sends a JSON object to the caller with either the\n          // requested OData or error information.\n\n          let error;\n          if (response.statusCode === 200) {\n            let parsedBody = JSON.parse(body);\n            resolve(parsedBody);\n          } else {\n            error = new Error();\n            error.code = response.statusCode;\n            error.message = response.statusMessage;\n\n            // The error body sometimes includes an empty space\n            // before the first character, remove it or it causes an error.\n            body = body.trim();\n            error.bodyCode = JSON.parse(body).error.code;\n            error.bodyMessage = JSON.parse(body).error.message;\n            resolve(error);\n          }\n        });\n      })\n      .on(\"error\", reject);\n  });\n}\n","/*\n * Copyright (c) Microsoft. All rights reserved. Licensed under the MIT license. See full license in root of repo. -->\n *\n * This file defines the routes within the authRoute router.\n */\n\nimport fetch from \"node-fetch\";\nimport form from \"form-urlencoded\";\nimport jwt from \"jsonwebtoken\";\nimport { JwksClient } from \"jwks-rsa\";\n\n/* global process, console */\n\nconst DISCOVERY_KEYS_ENDPOINT = \"https://login.microsoftonline.com/common/discovery/v2.0/keys\";\n\nexport async function getAccessToken(authorization: string): Promise<any> {\n  if (!authorization) {\n    let error = new Error(\"No Authorization header was found.\");\n    return Promise.reject(error);\n  } else {\n    const scopeName: string = process.env.SCOPE || \"User.Read\";\n    const [, /* schema */ assertion] = authorization.split(\" \");\n\n    const tokenScopes = (jwt.decode(assertion) as jwt.JwtPayload).scp.split(\" \");\n    const accessAsUserScope = tokenScopes.find((scope) => scope === \"access_as_user\");\n    if (!accessAsUserScope) {\n      throw new Error(\"Missing access_as_user\");\n    }\n\n    const formParams = {\n      client_id: process.env.CLIENT_ID,\n      client_secret: process.env.CLIENT_SECRET,\n      grant_type: \"urn:ietf:params:oauth:grant-type:jwt-bearer\",\n      assertion: assertion,\n      requested_token_use: \"on_behalf_of\",\n      scope: [scopeName].join(\" \"),\n    };\n\n    const stsDomain: string = \"https://login.microsoftonline.com\";\n    const tenant: string = \"common\";\n    const tokenURLSegment: string = \"oauth2/v2.0/token\";\n    const encodedForm = form(formParams);\n\n    const tokenResponse = await fetch(`${stsDomain}/${tenant}/${tokenURLSegment}`, {\n      method: \"POST\",\n      body: encodedForm,\n      headers: {\n        Accept: \"application/json\",\n        \"Content-Type\": \"application/x-www-form-urlencoded\",\n      },\n    });\n    const json = await tokenResponse.json();\n    return json;\n  }\n}\n\nexport function validateJwt(req, res, next): void {\n  const authHeader = req.headers.authorization;\n  if (authHeader) {\n    const token = authHeader.split(\" \")[1];\n\n    const validationOptions = {\n      audience: process.env.CLIENT_ID,\n    };\n\n    jwt.verify(token, getSigningKeys, validationOptions, (err) => {\n      if (err) {\n        console.log(err);\n        return res.sendStatus(403);\n      }\n\n      next();\n    });\n  }\n}\n\nfunction getSigningKeys(header: any, callback: any) {\n  var client: JwksClient = new JwksClient({\n    jwksUri: DISCOVERY_KEYS_ENDPOINT,\n  });\n\n  client.getSigningKey(header.kid, function (err, key) {\n    callback(null, key.getPublicKey());\n  });\n}\n","module.exports = require(\"cookie-parser\");","module.exports = require(\"dotenv\");","module.exports = require(\"express\");","module.exports = require(\"form-urlencoded\");","module.exports = require(\"http-errors\");","module.exports = require(\"jsonwebtoken\");","module.exports = require(\"jwks-rsa\");","module.exports = require(\"morgan\");","module.exports = require(\"node-fetch\");","module.exports = require(\"office-addin-dev-certs\");","module.exports = require(\"path\");","module.exports = require(\"https\");","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","/*\n * Copyright (c) Microsoft. All rights reserved. Licensed under the MIT license. See full license in root of repo. -->\n *\n * This file is the main Node.js server file that defines the express middleware.\n */\n\nif (process.env.NODE_ENV !== \"production\") {\n  require(\"dotenv\").config();\n}\nimport * as createError from \"http-errors\";\nimport * as path from \"path\";\nimport * as cookieParser from \"cookie-parser\";\nimport * as logger from \"morgan\";\nimport express from \"express\";\nimport https from \"https\";\nimport { getHttpsServerOptions } from \"office-addin-dev-certs\";\nimport { getUserData } from \"./msgraph-helper\";\nimport { validateJwt } from \"./ssoauth-helper\";\n\n/* global console, process, require, __dirname */\n\nconst app = express();\nconst port: number | string = process.env.API_PORT || \"3000\";\n\napp.set(\"port\", port);\n\n// view engine setup\napp.set(\"views\", path.join(__dirname, \"views\"));\napp.set(\"view engine\", \"pug\");\n\napp.use(logger(\"dev\"));\napp.use(express.json());\napp.use(express.urlencoded({ extended: false }));\napp.use(cookieParser());\n\n/* Turn off caching when developing */\nif (process.env.NODE_ENV !== \"production\") {\n  app.use(express.static(path.join(process.cwd(), \"dist\"), { etag: false }));\n\n  app.use(function (req, res, next) {\n    res.header(\"Cache-Control\", \"private, no-cache, no-store, must-revalidate\");\n    res.header(\"Expires\", \"-1\");\n    res.header(\"Pragma\", \"no-cache\");\n    next();\n  });\n} else {\n  // In production mode, let static files be cached.\n  app.use(express.static(path.join(process.cwd(), \"dist\")));\n}\n\nconst indexRouter = express.Router();\nindexRouter.get(\"/\", function (req, res) {\n  res.render(\"/taskpane.html\");\n});\n\napp.use(\"/\", indexRouter);\n\n// Middle-tier API calls\n// listen for 'ping' to verify service is running\n// Un comment for development debugging, but un needed for production deployment\n// app.get(\"/ping\", function (req: any, res: any) {\n//   res.send(process.platform);\n// });\n\n//app.get(\"/getuserdata\", validateJwt, getUserData);\napp.get(\"/getuserdata\", validateJwt, getUserData);\n\n// Get the client side task pane files requested\napp.get(\"/taskpane.html\", async (req: any, res: any) => {\n  return res.sendfile(\"taskpane.html\");\n});\n\napp.get(\"/fallbackauthdialog.html\", async (req: any, res: any) => {\n  return res.sendfile(\"fallbackauthdialog.html\");\n});\n\n// Catch 404 and forward to error handler\napp.use(function (req: any, res: any, next: any) {\n  next(createError(404));\n});\n\n// error handler\napp.use(function (err: any, req: any, res: any) {\n  // set locals, only providing error in development\n  res.locals.message = err.message;\n  res.locals.error = req.app.get(\"env\") === \"development\" ? err : {};\n\n  // render the error page\n  res.status(err.status || 500);\n  res.render(\"error\");\n});\n\ngetHttpsServerOptions().then((options) => {\n  https\n    .createServer(options, app)\n    .listen(port, () => console.log(`Server running on ${port} in ${process.env.NODE_ENV} mode`));\n});\n"],"names":["https","getAccessToken","createError","domain","version","getUserData","req","res","next","authorization","get","then","graphTokenResponse","claims","error","send","graphToken","access_token","graphUrlSegment","process","env","GRAPH_URL_SEGMENT","graphQueryParamSegment","QUERY_PARAM_SEGMENT","graphData","getGraphData","code","JSON","stringify","catch","err","status","message","accessToken","apiUrl","queryParams","Promise","resolve","reject","options","host","path","method","headers","Accept","Authorization","Expires","Pragma","response","body","on","d","statusCode","parsedBody","parse","Error","statusMessage","trim","bodyCode","bodyMessage","fetch","form","jwt","JwksClient","DISCOVERY_KEYS_ENDPOINT","scopeName","SCOPE","assertion","split","tokenScopes","decode","scp","accessAsUserScope","find","scope","formParams","client_id","CLIENT_ID","client_secret","CLIENT_SECRET","grant_type","requested_token_use","join","stsDomain","tenant","tokenURLSegment","encodedForm","tokenResponse","json","validateJwt","authHeader","token","validationOptions","audience","verify","getSigningKeys","console","log","sendStatus","header","callback","client","jwksUri","getSigningKey","kid","key","getPublicKey","NODE_ENV","require","config","cookieParser","logger","express","getHttpsServerOptions","app","port","API_PORT","set","__dirname","use","urlencoded","extended","static","cwd","etag","indexRouter","Router","render","sendfile","locals","createServer","listen"],"sourceRoot":""}